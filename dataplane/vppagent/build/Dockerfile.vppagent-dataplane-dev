ARG VPP_AGENT
ARG VPP_DEV

FROM golang:alpine as build
FROM ${VPP_DEV} as vpp_dev
FROM ${VPP_AGENT}

ENV POSTMORTEM_DATA_LOCATION=/var/tmp/nsm-postmortem/vpp-dataplane

COPY dataplane/vppagent/conf/supervisord/supervisord-dev.conf /etc/supervisord/supervisord.conf
COPY dataplane/vppagent/scripts/prepare_postmortem.sh /usr/bin/prepare_postmortem.sh
COPY dataplane/vppagent/scripts/vpp_listener.py /usr/bin/vpp_listener.py

COPY --from=vpp_dev \
    /opt/vpp-agent/dev/vpp/build-root/vpp-dev_*.deb \
    /opt/vpp-agent/dev/vpp/build-root/vpp-dbg_*.deb \
    /opt/vpp-agent/dev/vpp/build-root/vpp-api-python_*.deb \
 /opt/vpp/

RUN apt-get update && apt-get install -y zip python python-cffi python-enum34 \
  && cd /opt/vpp/ \
  && dpkg -i vpp-dev_*.deb vpp-dbg_*.deb vpp-api-python_*.deb \
  && rm vpp*.deb

COPY --from=networkservicemesh/vppagent-dataplane:latest /bin/vppagent-dataplane /bin/vppagent-dataplane
RUN rm /opt/vpp-agent/dev/etcd.conf /opt/vpp-agent/dev/kafka.conf; echo 'Endpoint: "localhost:9111"' > /opt/vpp-agent/dev/grpc.conf
COPY dataplane/vppagent/conf/vpp/startup.conf /etc/vpp/vpp.conf
COPY dataplane/vppagent/conf/supervisord/supervisord.conf /etc/supervisord/supervisord.conf

