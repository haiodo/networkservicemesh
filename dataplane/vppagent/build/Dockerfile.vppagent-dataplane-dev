ARG VPP_AGENT
ARG VPP_DEV
ARG REPO
ARG COMMIT

FROM golang:alpine as build
FROM ${VPP_DEV} as vpp_dev
FROM ${VPP_AGENT} as vpp_agent

ENV POSTMORTEM_DATA_LOCATION=/var/tmp/nsm-postmortem/vpp-dataplane

COPY dataplane/vppagent/conf/supervisord/supervisord-dev.conf /etc/supervisord/supervisord.conf
COPY dataplane/vppagent/scripts/prepare_postmortem.sh /usr/bin/prepare_postmortem.sh
COPY dataplane/vppagent/scripts/vpp_listener.py /usr/bin/vpp_listener.py

COPY --from=vpp_dev \
    /opt/vpp-agent/dev/vpp/build-root/vpp-dev_*.deb \
    /opt/vpp-agent/dev/vpp/build-root/vpp-dbg_*.deb \
    /opt/vpp-agent/dev/vpp/build-root/vpp-api-python_*.deb \
 /opt/vpp/

RUN apt-get update && apt-get install -y zip python python-cffi python-enum34 \
  && cd /opt/vpp/ \
  && dpkg -i vpp-dev_*.deb vpp-dbg_*.deb vpp-api-python_*.deb \
  && rm vpp*.deb

RUN rm /opt/vpp-agent/dev/etcd.conf; echo 'Endpoint: "localhost:9111"' > /opt/vpp-agent/dev/grpc.conf
COPY dataplane/vppagent/conf/vpp/startup.conf /etc/vpp/vpp.conf
COPY dataplane/vppagent/conf/supervisord/supervisord.conf /etc/supervisord/supervisord.conf

FROM networkservicemesh/builder:latest as build_vpp
RUN CGO_ENABLED=0 GOOS=linux go build  -i -ldflags '-extldflags "-static"' -o /go/bin/vppagent-dataplane ./dataplane/vppagent/cmd/vppagent-dataplane.go

FROM vpp_agent
COPY --from=build_vpp /go/bin/vppagent-dataplane /bin/vppagent-dataplane
CMD [ "/bin/sh", "-c", "rm -f /dev/shm/db /dev/shm/global_vm /dev/shm/vpe-api &&     /usr/bin/supervisord -c /etc/supervisord/supervisord.conf"]

